<?php
/**
 * @file
 * A module that allows users to create and order custom business cards.
 */

/**
 * Implements hook_help().
 */
function card_creator_help($path, $arg) {
  switch ($path) {
    case 'admin/help#card_creator':{
      $ret_val = '<h3>' . t('About') . '</h3>';
      $ret_val .= '<p>' . t('Allows customers to create and order custom business cards.') . '</p>';
      return $ret_val;
      break;
    }
  }
}

/**
 * Implements hook_permission().
 */
function card_creator_permission() {
  return array(
    'administer card creator' => array(
      'title' => t('Administer Card Creator'),
      'description' => t('Perform administrative task on Card Creator functionality.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function card_creator_menu() {
  $items = array();

  // Business card creation page
  $items['card-creator'] = array(
    'description' => 'Customize your business card.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('card_creator_form'),
    'access callback' => TRUE,
  );

  // Create page for ajax front callback
  $items['card-creator-ajax-front'] = array(
    'title' => t('Card Creator AJAX front'),
    'type' => MENU_CALLBACK,
    'page callback' => 'card_creator_ajax_front',
    'access arguments' => array('access content'),
  );

  // Create page for ajax back callback
  $items['card-creator-ajax-back'] = array(
    'title' => t('Card Creator AJAX back'),
    'type' => MENU_CALLBACK,
    'page callback' => 'card_creator_ajax_back',
    'access arguments' => array('access content'),
  );

  return $items;
}

/**
 * Implement the card_creator_ajax_front callback.
 *
 * Saves an image of the front of the business card the user has created.
 */
function card_creator_ajax_front() {
  // Define the file directory to be used for storing users business cards.
  define('UPLOAD_DIR', 'sites/default/files/tmp/');

  // Get the svg.toDataUrl thats being passed via AJAX
  $img = $_POST['img'];
  // Get the Company Name for the card being created
  $company_name = $_POST['company_name'];
  $company_name = str_replace(' ', '', $company_name); // Removes all spaces
  $company_name = preg_replace('/[^A-Za-z0-9\-]/', '', $company_name); // Removes special chars
  // Get the Name of the customer the card is being created for
  $name = $_POST['name'];
  $name = str_replace(' ', '', $name); // Removes all spaces
  $name = preg_replace('/[^A-Za-z0-9\-]/', '', $name); // Removes special chars
  // Prepare dataURL to be saved as a file
  $img = str_replace('data:image/svg+xml;base64,', '', $img);
  $img = str_replace(' ', '+', $img);
  $data = base64_decode($img);
  $file = UPLOAD_DIR . $company_name . '-' . $name . '.svg';

  // Save an SVG of the card the user created
  $success = file_put_contents($file, $data);

  print $success ? $file : 'Unable to save the file.';
}

/**
 * Implement the card_creator_ajax_front callback.
 *
 * Saves an image of the front of the business card the user has created.
 */
function card_creator_ajax_back() {
  // Define the file directory to be used for storing users business cards.
  define('UPLOAD_DIR', 'sites/default/files/tmp/');

  // Get the svg.toDataUrl thats being passed via AJAX
  $img = $_POST['img'];
  // Get the Company Name for the card being created
  $company_name = $_POST['company_name'];
  $company_name = str_replace(' ', '', $company_name); // Removes all spaces
  $company_name = preg_replace('/[^A-Za-z0-9\-]/', '', $company_name); // Removes special chars
  // Get the Name of the customer the card is being created for
  $name = $_POST['name'];
  $name = str_replace(' ', '', $name); // Removes all spaces
  $name = preg_replace('/[^A-Za-z0-9\-]/', '', $name); // Removes special chars
  // Prepare dataURL to be saved as a file
  $img = str_replace('data:image/svg+xml;base64,', '', $img);
  $img = str_replace(' ', '+', $img);
  $data = base64_decode($img);
  $file = UPLOAD_DIR . $company_name . '-' . $name . '-back' . '.svg';

  // Save an SVG of the card the user created
  $success = file_put_contents($file, $data);

  print $success ? $file : 'Unable to save the file.';
}

/**
 * Implements hook_form().
 */
function card_creator_form($form, &$form_state) {
  $form = array();

  // Attach css, js, and library files
  $form['#attached']['css'] = array(
    drupal_get_path('module', 'card_creator') . '/css/styles.css',
  );

  // Input Fields for Front
  $form['card_information'] = array(
    '#markup' => '<h4>' . t('1) Enter Card Information') . '</h4>',
    '#prefix' => '<div id="container"><div id="leftColumn"><div id="cardInfoFront">',
  );
  $form['company_name'] = array(
    '#type' => 'textfield',
    '#id' => 'companyName',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Company Name'),
    ),
  );
  $form['name'] = array(
    '#type' => 'textfield',
    '#id' => 'name',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Name'),
    ),
  );
  $form['title'] = array(
    '#type' => 'textfield',
    '#id' => 'title',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Title'),
    ),
  );
  $form['address'] = array(
    '#type' => 'textfield',
    '#id' => 'address',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Address'),
    ),
  );
  $form['city_state_zip'] = array(
    '#type' => 'textfield',
    '#id' => 'cityStateZip',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('City, State Zip'),
    ),
  );
  $form['line1'] = array(
    '#type' => 'textfield',
    '#id' => 'line1',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Line 1'),
    ),
  );
  $form['line2'] = array(
    '#type' => 'textfield',
    '#id' => 'line2',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Line 2'),
    ),
  );
  $form['line3'] = array(
    '#type' => 'textfield',
    '#id' => 'line3',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => ('Line 3'),
    ),
  );
  $form['line4'] = array(
    '#type' => 'textfield',
    '#id' => 'line4',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => ('Line 4'),
    ),
    '#suffix' => '</div>',
  );

  // Input Fields for Back

  $form['card_information_back'] = array(
    '#markup' => '<h4>' . t('1) Enter Card Information') . '</h4>',
    '#prefix' => '<div id="cardInfoBack">',
  );
  $form['back_line_1'] = array(
    '#type' => 'textfield',
    '#id' => 'backLine1',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Line 1'),
    ),
  );
  $form['back_line_2'] = array(
    '#type' => 'textfield',
    '#id' => 'backLine2',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Line 2'),
    ),
  );
  $form['back_line_3'] = array(
    '#type' => 'textfield',
    '#id' => 'backLine3',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Line 3'),
    ),
  );
  $form['back_line_4'] = array(
    '#type' => 'textfield',
    '#id' => 'backLine4',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Line 4'),
    ),
  );
  $form['back_line_5'] = array(
    '#type' => 'textfield',
    '#id' => 'backLine5',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Line 5'),
    ),
  );
  $form['back_line_6'] = array(
    '#type' => 'textfield',
    '#id' => 'backLine6',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Line 6'),
    ),
  );
  $form['back_line_7'] = array(
    '#type' => 'textfield',
    '#id' => 'backLine7',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => t('Line 7'),
    ),
  );
  $form['back_line_8'] = array(
    '#type' => 'textfield',
    '#id' => 'backLine8',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => ('Line 8'),
    ),
  );
  $form['back_line_9'] = array(
    '#type' => 'textfield',
    '#id' => 'backLine9',
    '#size' => 25,
    '#attributes' => array(
      'placeholder' => ('Line 9'),
    ),
    '#suffix' => '</div>',
  );

  // Font Family Select List
  $form['font_family'] = array(
    '#markup' => 'Select Font Family <select id="docFontFamily" title="Change the font for ALL fields."><option value="helvetica">Helvetica</option><option value="futura">Futura</option><option value="garamond">Garamond</option><option value="frutiger">Frutiger</option></select>',
    '#suffix' => '</div>',
  );

  $form['two_sided_options'] = array(
    '#prefix' => '<div id="midColumn"><div id="twoSidedOptions">',
    '#markup' => '<button id="addBack" type="button">Add a Back</button><button id="removeBack" type="button">Remove Back</button>',
    '#suffix' => '</div>',
  );
  $form['two_sided'] = array(
    '#type' => 'checkbox',
    '#title' => t('Two Sided Card?'),
    '#prefix' => '<div id="selectTwoSided">',
    '#suffix' => '</div>',
  );
  // Two Sided Options
  $form['front_back'] = array(
    '#prefix' => '<div id="frontBack">',
    '#markup' => '<button id="front" type="button">Front</button><button id="back" type="button">Back</button>',
    '#suffix' => '</div>',
  );
  // Preview svg
  $form['previewFront'] = array(
    '#markup' => '<svg id="previewFront"></svg>',
  );
  $form['previewBack'] = array(
    '#markup' => '<svg id="previewBack"></svg>',
    '#suffix' => '</div>',
  );


  // Template Selection
  $form['select_template'] = array(
    '#markup' => '<h4>' . t('2) Select a Template') . '</h4>',
    '#prefix' => '<div id="rightColumn">',
  );

  // Templates svg displays
  $form['templates_front'] = array(
    '#markup' => '<svg id="templatesFront"></svg>',
    '#prefix' => '<div id="rightColumnlower"><div id="templatesFrontDisplay">',
    '#suffix' => '</div>',
  );
  $form['templates_back'] = array(
    '#markup' => '<svg id="templatesBack"></svg>',
    '#prefix' => '<div id="templatesBackDisplay">',
    '#suffix' => '</div></div></div>',
  );
  // Clipart selection
  $form['select_clipart'] = array(
    '#markup' => '<h4>' . t('3) Select Clipart') . '</h4>',
    '#prefix' => '<div id="bottom"><div id="bottomColOne"><div id="bottomColOneUpper">',
    '#suffix' => '</div>',
  );
  // Clipart Color Label
  $form['clipart_color'] = array(
    '#markup' => '<div><h5 id="clipartColor">' . t('Clipart Color') . '</h5></div>',
  );
  // Clipart Category
  $form['clipart_category'] = array(
    '#markup' => '<select id="clipartCategory" title="Select Clipart Category."><option value="vehicles">Vehicles</option><option value="manufacturer">Manufactuer logo\'s</option><option value="animals">Animals</option></select>',
    '#prefix' => '<div id="clipart_category">',
    '#suffix' => '</div>',
  );

  // Clipart svg dispaly
  $form['clipart'] = array(
    '#markup' => '<svg id="clipart"></svg>',
    '#prefix' => '<div id="bottomColOneLower">',
    '#suffix' => '</div></div>',
  );

  // Ink Color Selection
  $form['select_ink_color'] = array(
    '#markup' => '<h4>' . t('4) Select Ink Color') . '</h4>',
    '#prefix' => '<div id="bottomColTwo"><div id="bottomColTwoUpper">',
  );
  $form['two_color'] = array(
    '#type' => 'checkbox',
    '#title' => t('Two Color Card?'),
    '#prefix' => '<div id="selectTwoColor">',
    '#suffix' => '</div></div>',
  );

  // One Color Options
  $form['black'] = array(
    '#markup' => '<button type="button">Black</button>',
    '#prefix' => '<div id="bottomColTwoLower"><div id="oneColor">',
  );
  $form['red'] = array(
    '#markup' => '<button type="button">Red</button>',
  );
  $form['blue'] = array(
    '#markup' => '<button type="button">Blue</button>',
  );
  $form['maroon'] = array(
    '#markup' => '<button type="button">Maroon</button>',
  );
  $form['green'] = array(
    '#markup' => '<button type="button">Green</button>',
  );
  $form['brown'] = array(
    '#markup' => '<button type="button">Brown</button>',
    '#suffix' => '</div>',
  );

  // Two Color Options
  $form['red_blue'] = array(
    '#markup' => '<button type="button">Red/Blue</button>',
    '#prefix' => '<div id="twoColors">',
  );
  $form['red_black'] = array(
    '#markup' => '<button type="button">Red/Black</button>',
  );
  $form['blue_black'] = array(
    '#markup' => '<button type="button">Blue/Black</button>',
  );
  $form['maroon_black'] = array(
    '#markup' => '<button type="button">Maroon/Black</button>',
  );
  $form['green_black'] = array(
    '#markup' => '<button type="button">Green/Black</button>',
  );
  $form['brown_black'] = array(
    '#markup' => '<button type="button">Brown/Black</button>',
    '#suffix' => '</div></div></div>'
  );

  // Card Stock Selection
  $form['card_stock'] = array(
    '#markup' => '<h4>' . t('5) Chose Card Stock') . '</h4>',
    '#prefix' => '<div id="bottomColThree"><div id="bottomColThreeUpper">',
    '#suffix' => '</div>',
  );
  // Build Card Stock Options
  $card_stocks = array(
    '1' => t('White Smooth'),
    '2' => t('White Linen'),
    '3' => t('Soft White Linen'),
    '4' => t('Tan Linen'),
    '5' => t('Gray Linen'),
    '6' => t('Yellow'),
    '7' => t('Kromekote'),
    '8' => t('Woodgrain'),
  );
  // Display Card Stock Options
  $form['card_stock_options'] = array(
    '#type' => 'radios',
    '#prefix' => '<div id="bottomColThreeLower">',
    '#options' => $card_stocks,
    '#default_value' => '1',
    '#suffix' => '</div></div>',
  );

  // Qunatity
  $form['qunatity'] = array(
    '#markup' => '<h4>' . t('6) Select Qunatity') . '</h4>',
    '#prefix' => '<div id="bottomColFour"><div id="bottomColFourUpper">',
    '#suffix' => '</div>',
  );
  // Build Quantity Options
  $quantitys = array(
    '9' => '500',
    '10' => '1000',
    '11' => '2000',
    '12' => '3000',
    '13' => '4000',
    '14' => '5000',
    '15' => '10000',
  );
  // Display Quantity Options
  $form['select_quantity'] = array(
    '#type' => 'radios',
    '#options' => $quantitys,
    '#default_value' => '9',
    '#prefix' => '<div id="bottomColFourLower"><div id="select_quantity">',
    '#suffix' => '</div>',
  );
  // Price
  $form['current_price'] = array(
    '#markup' => t('Price = $14.95'),
    '#prefix' => '<div id="continue"><div id="currentPrice">',
    '#suffix' => '</div>',
  );
  // Continue
  $form['continue'] = array(
    '#markup' => '<button id="continue_button">Continue</button>',
    '#suffix' => '</div></div></div></div>',
  );

  // Create div for proof
  $form['proof'] = array(
    '#markup' => '<img id="proofImageFront"></img><img id="proofImageBack"></img>',
    '#prefix' => '<div id="proof">',
  );

  $form['approve_proof'] = array(
    '#type' => 'checkbox',
    '#title' => 'I have checked this card for errors.',
  );

  $form['edit'] = array(
    '#markup' => '<button id="edit">Edit</button>',
  );

  // Add To Cart
  $form['add_to_cart'] = array(
    '#type' => 'submit',
    '#id' => 'addToCart',
    '#value' => t('Add to cart'),
    '#suffix' => '</div>',
  );

  // Include libraries
  $form['#attached']['js'][] = array(
    'data' => drupal_get_path('module', 'card_creator') . '/libraries/snap.svg.js',
  );

  $form['#attached']['js'][] = array(
    'data' => drupal_get_path('module', 'card_creator') . '/libraries/svg_todataurl.js',
  );

  // Include js for card_creator functionality.
  $form['#attached']['js'][] = array(
    'data' => drupal_get_path('module', 'card_creator') . '/js/card_creator.js',
  );

  return $form;
}

/**
 * Validates Card Creator Form.
 */

function card_creator_form_validate($form, &$form_state) {

}

/**
 * Process a validated Card Creator Form submission.
 */

function card_creator_form_submit($form, &$form_state) {
  global $user;
  // Price in minors units 500 = 5$
  $price;
  $company_name = $form_state['values']['company_name'];
  $name = $form_state['values']['name'];
  $title = $form_state['values']['title'];
  $address = $form_state['values']['address'];
  $city_state_zip = $form_state['values']['city_state_zip'];
  $line1 = $form_state['values']['line1'];
  $line2 = $form_state['values']['line2'];
  $line3 = $form_state['values']['line3'];
  $line4 = $form_state['values']['line4'];
  $two_color_card = $form_state['values']['two_color'];
  $selected_card_stock = $form_state['values']['card_stock_options'];
  $selected_quantity = $form_state['values']['select_quantity'];
  $two_sided_card = $form_state['values']['two_sided'];
  $product_title = str_replace(' ', '', $company_name) . '-' . str_replace(' ', '', $name);

  // Back Side Fields
  $back_line1 = $form_state['values']['back_line_1'];
  $back_line2 = $form_state['values']['back_line_2'];
  $back_line3 = $form_state['values']['back_line_3'];
  $back_line4 = $form_state['values']['back_line_4'];
  $back_line5 = $form_state['values']['back_line_5'];
  $back_line6 = $form_state['values']['back_line_6'];
  $back_line7 = $form_state['values']['back_line_7'];
  $back_line8 = $form_state['values']['back_line_8'];
  $back_line9 = $form_state['values']['back_line_9'];

  // Proof Approval
  $approve_proof = $form_state['values']['approve_proof'];

  // If the proof has been approved
  if ($approve_proof != 0) {
    // If this is NOT a two sided card
    if ($two_sided_card == 0) {
      $product_id = 1;

      // Create the new order in checkout; you might also cheeck first to
      // see if your user already has an order to use instead of a new one.
      $order = commerce_order_new($user->uid, 'checkout_checkout');

      // Save the order to get its ID.
      commerce_order_save($order);

      // Load whatever product represents the item the customer will be
      // paying for and create a line item for it.
      $product = commerce_product_load($product_id);
      $line_item = commerce_product_line_item_new($product, 1, $order->order_id, array(), 'business_card');

      // Add the custom values to the line_item fields
      foreach ($line_item as $field_name => $value) {
        $line_item->field_quantity['und'][0]['tid'] = $selected_quantity;
        $line_item->field_card_stocks['und'][0]['tid'] = $selected_card_stock;
        $line_item->field_company_name[LANGUAGE_NONE][0]['value'] = $company_name;
        $line_item->field_name[LANGUAGE_NONE][0]['value'] = $name;
        $line_item->field_title[LANGUAGE_NONE][0]['value'] = $title;
        $line_item->field_address[LANGUAGE_NONE][0]['value'] = $address;
        $line_item->field_city_state_zip[LANGUAGE_NONE][0]['value'] = $city_state_zip;
        $line_item->field_line_1[LANGUAGE_NONE][0]['value'] = $line1;
        $line_item->field_line_2[LANGUAGE_NONE][0]['value'] = $line2;
        $line_item->field_line_3[LANGUAGE_NONE][0]['value'] = $line3;
        $line_item->field_line_4[LANGUAGE_NONE][0]['value'] = $line4;
      }


      // Save the line item to get its ID.
      commerce_line_item_save($line_item);

      // Add the line item to the order using the wrapper.
      $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
      $order_wrapper->commerce_line_items[] = $line_item;

      dpm(get_defined_vars());

      // Save the order again to update its line item reference field.
      commerce_order_save($order);

      // Redirect to the order's checkout form.
      $form_state['redirect'] = 'cart';

      // ['line_item']->field_quantity['und'][0]['tid']

      // // Save Image
      // $company_name = str_replace(' ', '', $company_name); // Removes all spaces
      // $company_name = preg_replace('/[^A-Za-z0-9\-]/', '', $company_name); // Removes special chars
      // $name = str_replace(' ', '', $name); // Removes all spaces
      // $name = preg_replace('/[^A-Za-z0-9\-]/', '', $name); // Removes special chars
      // $filepath = 'sites/default/files/tmp/'. $company_name . '-' . $name . '.svg';
      // $file = (object) array(
      //   'filename' => basename($filepath),
      //   'filepath' => $filepath,
      //   'filemime' => file_get_mimetype($filepath),
      //   'filesize' => filesize($filepath),
      //   'uid' => 1,
      //   'status' => FILE_STATUS_PERMANENT,
      //   'uri' => $filepath,
      //   'display' => 1,
      //   'description' => '',
      // );

      // $file = file_move($file, 'public://', FILE_EXISTS_REPLACE);
      // $wrapper->field_business_card_image = array('fid' => $file->fid);

      // // Save product
      // $wrapper->save();
    } elseif ($two_sided_card == 1) { // If this is a two sided card
      // Use the information submitted to create a new business card product
      // Front Info
      $wrapper = entity_metadata_wrapper('commerce_product', commerce_product_new('two_sided_business_card'));
      $wrapper->title = $product_title;
      $wrapper->sku = $product_title;
      $wrapper->commerce_price->amount = $price;
      $wrapper->commerce_price->currency_code = 'USD';
      $wrapper->field_company_name = $company_name;
      $wrapper->field_name = $name;
      $wrapper->field_title = $title;
      $wrapper->field_address = $address;
      $wrapper->field_city_state_zip = $city_state_zip;
      $wrapper->field_line_1 = $line1;
      $wrapper->field_line_2 = $line2;
      $wrapper->field_line_3 = $line3;
      $wrapper->field_line_4 = $line4;

      // Back info
      $wrapper->field_back_line_1 = $back_line1;
      $wrapper->field_back_line_2 = $back_line2;
      $wrapper->field_back_line_3 = $back_line3;
      $wrapper->field_back_line_4 = $back_line4;
      $wrapper->field_back_line_5 = $back_line5;
      $wrapper->field_back_line_6 = $back_line6;
      $wrapper->field_back_line_7 = $back_line7;
      $wrapper->field_back_line_8 = $back_line8;
      $wrapper->field_back_line_9 = $back_line9;

      // Generate info for file names
      $company_name = str_replace(' ', '', $company_name); // Removes all spaces
      $company_name = preg_replace('/[^A-Za-z0-9\-]/', '', $company_name); // Removes special chars
      $name = str_replace(' ', '', $name); // Removes all spaces
      $name = preg_replace('/[^A-Za-z0-9\-]/', '', $name); // Removes special chars

      // Generate file info for Front
      $filepathFront = 'sites/default/files/tmp/'. $company_name . '-' . $name . '.svg';
      $fileFront = (object) array(
        'filename' => basename($filepathFront),
        'filepath' => $filepathFront,
        'filemime' => file_get_mimetype($filepathFront),
        'filesize' => filesize($filepathFront),
        'uid' => 1,
        'status' => FILE_STATUS_PERMANENT,
        'uri' => $filepathFront,
        'display' => 1,
        'description' => '',
      );

      // Generate file info for Back
      $filepathBack = 'sites/default/files/tmp/'. $company_name . '-' . $name . '-back' . '.svg';
      $fileBack = (object) array(
        'filename' => basename($filepathBack),
        'filepath' => $filepathBack,
        'filemime' => file_get_mimetype($filepathBack),
        'filesize' => filesize($filepathBack),
        'uid' => 1,
        'status' => FILE_STATUS_PERMANENT,
        'uri' => $filepathBack,
        'display' => 1,
        'description' => '',
      );

      // Save Front
      $fileFront = file_move($fileFront, 'public://', FILE_EXISTS_REPLACE);
      $wrapper->field_business_card_image_front = array('fid' => $fileFront->fid);

      // Save Back
      $fileBack = file_move($fileBack, 'public://', FILE_EXISTS_REPLACE);
      $wrapper->field_business_card_image_back = array('fid' => $fileBack->fid);

      // Save product
      $wrapper->save();
    }

  }
}


